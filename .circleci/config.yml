---
version: 2

build-steps: &build-steps
  steps:
    - checkout
    - restore_cache:
        keys:
          - v1-stack-{{ checksum "package.yaml" }}-{{ checksum "stack.yaml" }}
          - v1-stack-{{ checksum "package.yaml" }}-
          - v1-stack-
        name: Restoring stack cache
    - run:
        name: Compile
        command: make build
    - run:
        name: Test
        command: make test
    - save_cache:
        key: v1-stack-{{ checksum "package.yaml" }}-{{ checksum "stack.yaml" }}
        name: Caching stack
        paths:
          - .stack-work
          - /root/.stack

jobs:
  ghc-8.2.2:
    <<: *build-steps
    docker:
      - image: haskell:8.2.2

  ghc-8.4.3:
    <<: *build-steps
    docker:
      - image: haskell:8.4.3

  for-github:
    docker:
      - image: alpine
    steps:
      - run:
          name: Passed
          command: echo passed

  sdist:
    docker:
      - image: haskell:8.2.2
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-stack-{{ checksum "package.yaml" }}-{{ checksum "stack.yaml" }}
            - v1-stack-{{ checksum "package.yaml" }}-
            - v1-stack-
          name: Restoring stack cache
      - run:
          name: Build sdist
          command: make sdist

workflows:
  version: 2
  base:
    jobs:
      - for-github:
          requires:
            - ghc-8.2.2
            - ghc-8.4.3
            - sdist
      - ghc-8.2.2
      - ghc-8.4.3
      - sdist
